# æ™®é€šå­—æ®µçš„æ³¨å…¥

æ™®é€šå­—æ®µå¯è®¤ä¸ºæ˜¯åŸºæœ¬æ•°æ®ç±»å‹ã€Stringã€Charç­‰è¿™äº›å¸¸è§çš„æ•°æ®ç±»å‹ã€‚

æ™®é€šå­—æ®µçš„æ³¨å…¥ä¸è‡ªå®šä¹‰å¼•ç”¨ç±»å‹ä½œä¸ºå­—æ®µæ³¨å…¥æ–¹å¼æ²¡å•¥åŒºåˆ«éƒ½è¦é€šè¿‡@Injectæˆ–è€…@Providesæ–¹å¼æä¾›å®ä¾‹ã€‚ä½†ç”±äºæ™®é€šæ•°æ®ç±»å‹ä¸ºç³»ç»Ÿæä¾›
å¥½çš„ç±»æˆ‘ä»¬åªèƒ½é€šè¿‡@Providesæ–¹å¼æä¾›å®ä¾‹äº†ã€‚

```kotlin
/**
 * Create by SunnyDay /12/13 17:04:59
 */
class CommonField @Inject constructor(val age:Int,val name: String)
```

å®šä¹‰Module&Provides

```kotlin
/**
 * Create by SunnyDay /12/13 17:10:52
 */
@Module
class CommonModule {
    @Provides
    fun provideAge():Int = 10
    @Provides
    fun provideName():String = "Kate"
}
```
å®¹å™¨ç®¡ç†

```kotlin
@Component(modules = [CommonModule::class])
interface ApplicationComponent {
    fun getCommonField():CommonField
}
```

# @IntoMapä¸@IntoSet

@IntoSetå’Œ@IntoMapç”¨æ³•ç±»ä¼¼ï¼Œå°±æ˜¯æŠŠç›®æ ‡æ•°æ®æ³¨å…¥åˆ°æŒ‡å®šçš„setæˆ–Mapä¸­ï¼Œè¿™æ ·å°±é¿å…äº†åˆå§‹åŒ–æ“ä½œå¯ç›´æ¥ä½¿ç”¨setæˆ–è€…mapã€‚

@IntoMapéœ€è¦åŒ@IntKeyæˆ–@StringKeyæˆ–è‡ªå®šä¹‰çš„@MapKeyä»¥åŠ@Provideæˆ–@Bindsä¸€èµ·ä½¿ç”¨ã€‚

ä¾‹å¦‚mapçš„keyä¸ºintç±»å‹åˆ™ç”¨@IntKeyï¼Œå¦‚æœä¸ºè‡ªå®šä¹‰ç±»å‹åˆ™éœ€è¦è‡ªå®šä¹‰æ³¨è§£å¹¶åœ¨è‡ªå®šä¹‰æ³¨è§£ä¸Šæ‰“ä¸Š@MapKeyã€‚

###### 1ã€@IntoSet

æ³¨å…¥è‡ªå®šä¹‰ç±»å‹æ•°æ®ä¸¾ä¸ªä¾‹å­ï¼Œä¸ºDaggerBasicActivityå®šä¹‰ä¸ªseté›†åˆå­—æ®µï¼Œseté›†åˆè‡ªåŠ¨æ³¨å…¥æ•°æ®ã€‚

```kotlin
abstract class Fragment
```

å®šä¹‰Moduleï¼Œæä¾›æ•°æ®æ³¨å…¥ã€‚

```kotlin
/**
 * Create by SunnyDay /12/14 14:18:31
 */
@Module
class IntoSetModule {
    @IntoSet
    @Provides
    fun provideFragment1() = object : Fragment() {}

    @IntoSet
    @Provides
    fun provideFragment2() = object : Fragment() {}
}
```

è®©å®¹å™¨ç®¡ç†Moduleï¼Œè´Ÿè´£æ³¨å…¥ ->

```kotlin
@Component(modules = [IntoSetModule::class])
interface ApplicationComponent {
      fun injectMap(activity: DaggerBasicActivity)
}
```

ä½¿ç”¨

```kotlin
class DaggerBasicActivity : AppCompatActivity() {
    /**
     * æ³¨æ„è¿™é‡Œè¿”å›å€¼ç±»å‹ä¸èƒ½ä¸ºSet<Fragment>å¦åˆ™æŠ¥é”™ï¼š
     * é”™è¯¯: [Dagger/MissingBinding] java.util.Set<? extends com.example.di.dagger_basic.repository.Fragment>
     *      cannot be provided without an @Provides-annotated method.
     * */
    @Inject
    lateinit var set: MutableSet<Fragment>

    override fun onCreate(savedInstanceState: Bundle?) {
        super.onCreate(savedInstanceState)
        val daggerContainer = (application as MyApplication).getDaggerContainer()
        //å­—æ®µæ³¨å…¥
        daggerContainer.injectMap(this)
        setContentView(R.layout.activity_dagger_basic)
        // ç›´æ¥ä½¿ç”¨
        set.forEach {
            println("set value:$it")
        }
    }
}
//log->

//I/System.out: set value:com.example.di.dagger_basic.modules.IntoSetModule$provideFragment1$1@4aaab3f
//I/System.out: set value:com.example.di.dagger_basic.modules.IntoSetModule$provideFragment2$1@e924c0c
```

###### 2ã€@IntoMap

```kotlin
class DaggerBasicActivity : AppCompatActivity() {
    // 1ã€Dagger å¸®æˆ‘ä»¬è‡ªåŠ¨å®ŒæˆMapçš„åˆå§‹åŒ–æ“ä½œ
    @Inject
    lateinit var map: Map<Int, String> //è¿™é‡Œä½¿ç”¨Map<Int,String> ç«Ÿç„¶ä¸ç¼–è¯‘crash ï¼Ÿï¼Ÿï¼Ÿï¼Ÿå¯¹æ¯”@IntoSet

    @RequiresApi(Build.VERSION_CODES.N)
    override fun onCreate(savedInstanceState: Bundle?) {
        super.onCreate(savedInstanceState)
        val daggerContainer = (application as MyApplication).getDaggerContainer()
        // å­—æ®µè‡ªåŠ¨æ³¨å…¥
        daggerContainer.injectMap(this)
        setContentView(R.layout.activity_dagger_basic)
        // ç›´æ¥å¯ä»¥ä½¿ç”¨Mapçš„æ•°æ®
        map.forEach { (t, u) ->
            println("key:$t value:$u")
        }
    }
}
```
å¾ˆç®€å•ï¼Œæ­¤æ—¶æˆ‘ä»¬åªæœ‰ä¸€ä¸ªç–‘é—®Map<Int, String>è¿”å›å€¼ç±»å‹çš„æ•°æ®æ˜¯å¦‚ä½•æä¾›çš„ï¼Ÿçœ‹->

```kotlin
/**
 * Create by SunnyDay /12/13 17:26:17
 */
@Module
class IntoMapModule {
    @Provides
    @IntoMap
    @IntKey(1)
    fun providerStudent1()="Tom"

    @Provides
    @IntoMap
    @IntKey(2)
    fun providerStudent2()="Kate"
}
```

ç„¶åè®©å®¹å™¨ç®¡ç† ->

```kotlin
@Component(modules = [IntoMapModule::class])
interface ApplicationComponent {
     // è¦é€šè¿‡æ³¨å…¥æ–¹å¼è·å–
    fun injectMap(activity:DaggerBasicActivity)
}
```

æ³¨æ„ç”¨æ³•ç»†èŠ‚ï¼š

- @IntoMapå’Œ@XxxKeyæˆå¯¹å‡ºç°
- @IntoMapéœ€è¦ç»“åˆ@Moduleä¸€èµ·é£Ÿç”¨ï¼ˆè¿™æ ·å°±ç›¸å½“äºè¦ç»“åˆ@Providersæ³¨è§£æˆ–è€…ç»“åˆ@Bindsæ³¨è§£ï¼‰
- mapä»¥å­—æ®µæ³¨å…¥æ–¹å¼ä½¿ç”¨ç»†èŠ‚

###### 2ã€custom map key

éå¸¸è§ç±»å‹ç±»ä½œä¸ºMapçš„keyéœ€è¦è‡ªå®šä¹‰Mapçš„keyï¼Œvalueå°±æ˜¯@provideræˆ–è€…@Bindsçš„è¿”å›å€¼ã€‚

```kotlin
/**
 * Create by SunnyDay /12/13 17:50:53
 */
open class Fragment
class HomeFragment:Fragment()
class HomeProfile:Fragment()
```

å®šä¹‰keyæ³¨è§£ ->

```kotlin
/**
 * Create by SunnyDay /12/13 17:55:31
 */
@MapKey
annotation class FragmentKey(val value: KClass<out Fragment>)// æ³¨æ„è¿™é‡Œä¸ºKClass
```

å®šä¹‰Module æä¾›Mapæ•°æ® ->

```kotlin
/**
 * Create by SunnyDay /12/13 17:54:19
 */
@Module
abstract class FragmentModule {

    @IntoMap
    @FragmentKey(HomeFragment::class)
    @Binds
    abstract fun providerHomeFragment(homeFragment: HomeFragment):Fragment


    @IntoMap
    @FragmentKey(ProfileFragment::class)
    @Binds
    abstract fun providerProfileFragment(profileFragment: ProfileFragment):Fragment

}
```

è¿™é‡Œä½¿ç”¨äº†@Bindsæ–¹å¼æä¾›æ•°æ®ï¼Œ@Bindsæ ‡æ³¨çš„æ–¹æ³•å‚æ•°ä¸ºå®ç°ç±»ï¼Œå®ç°ç±»çš„å…·ä½“å®ç°å¯é€šè¿‡@Providesæä¾›æ•°æ®

```kotlin
@Module
class ProviderModule{
    @Provides
    fun provideHomeFragment() = HomeFragment()

    @Provides
    fun provideProfileFragment() = ProfileFragment()

}
```

å®¹å™¨ç®¡ç†->

```kotlin
@Component(modules = [FragmentModule::class,IntoMapModule::class,ProviderModule::class])
interface ApplicationComponent {
      fun injectMap(activity: DaggerBasicActivity)
}
```

æ¥ä¸‹æ¥å°±æ˜¯ä½¿ç”¨äº†

```kotlin
class DaggerBasicActivity : AppCompatActivity() {

    /**
     * æ³¨æ„daggerç‰ˆæœ¬2.38.1è¿™é‡Œæœ‰å¤§å‘ï¼š
     * 
     * 1ã€æ ¹æ®æˆ‘ä»¬è‡ªå®šä¹‰çš„æ³¨è§£Keyç±»å‹ï¼Œè¿™é‡Œå¿…é¡»ä¸ºClassï¼Œè€Œä¸æ˜¯KClass
     * 2ã€ç¬¬äºŒä¸ªæ³›å‹å¿…é¡»æ·»åŠ @JvmSuppressWildcardsæ³¨è§£
     * 
     * è¯¦æƒ…åŸå› å‚è€ƒå®˜æ–¹é¿å‘æŒ‡å—ï¼šhttps://www.jianshu.com/p/7f4700fe30a9
     * */
    @Inject
    lateinit var fragmentMap: Map<Class<out Fragment>,@JvmSuppressWildcards Fragment>
    
    override fun onCreate(savedInstanceState: Bundle?) {
        super.onCreate(savedInstanceState)
        val daggerContainer = (application as MyApplication).getDaggerContainer()
        daggerContainer.injectMap(this)
        setContentView(R.layout.activity_dagger_basic)
        fragmentMap.forEach { (t, u) ->
            println("key:${t.canonicalName} value:$u")
        }
    }
}
```

# Daggerå®¹å™¨å¯¹è±¡çš„åˆ›å»º

é¦–å…ˆæˆ‘ä»¬çœ‹çœ‹å¸¸è§çš„æ —å­

```kotlin
interface Animal

class Dog @Inject constructor() : Animal

class Cat : Animal
```

```kotlin
@Module
interface BindsModule {

    @Binds
    fun bindsAnimal(dog:Dog):Animal
}

@Module
class ProvidersModule {
    @Provides
    fun providerCat() = Cat()
}
```

```kotlin
@Component(modules = [ProvidersModule::class, BindsModule::class])
interface AppComponent {
    fun getAnimal(): Animal

    fun getCat(): Cat
}
```

æœ€å¸¸è§çš„å°±æ˜¯ä½¿ç”¨å•¦ï¼Œæˆ‘ä»¬å¯èƒ½è¿™æ ·ä½¿ç”¨ï¼š

```kotlin
/**
 * Create by SunnyDay /12/24 19:18:58
 */
class MyApplication:Application() {

  private val appComponent:AppComponent = DaggerAppComponent.builder().build()
    override fun onCreate() {
        super.onCreate()
    }

    fun getContainer() = appComponent
}
```

```kotlin
class MainActivity : AppCompatActivity() {
    override fun onCreate(savedInstanceState: Bundle?) {
        super.onCreate(savedInstanceState)
        setContentView(R.layout.activity_main)
        val container = (application as MyApplication).getContainer()
        Log.d("My-test","cat:${container.getCat()}")
        Log.d("My-test","Animal:${container.getAnimal()}")
        //D  cat:com.example.otherusage.entity.Cat@7b12f1f
        //D  Animal:com.example.otherusage.entity.Dog@3c6b26c
    }
}
```

MyApplicationé‡Œé¢ä½¿ç”¨DaggerAppComponentæä¾›çš„buildæ–¹æ³•åˆ›å»ºAppComponentçš„å®ä¾‹ã€‚æˆ‘ä»¬å¯èƒ½ä¸€å¼€å§‹å°±è¿™æ ·å›ºå®šå†™äº†ï¼Œå¯æ˜¯ä½ æ€è€ƒè¿‡è¿˜æœ‰å…¶ä»–æ–¹å¼å—ï¼Ÿ

###### 1ã€Daggerå®¹å™¨é»˜è®¤åˆ›å»ºæ–¹å¼

è¿™é‡Œä»¥ä¸Šé¢çš„DaggerAppComponentä¸ºğŸŒ°ï¼Œåˆ›å»ºæ–¹å¼æœ‰å¦‚ä¸‹ä¸‰ç§

- DaggerAppComponent.create()
- DaggerAppComponent.builder().build()

(1)createæ–¹å¼

è¿™é‡Œæ˜¯Daggerä¸ºæˆ‘ä»¬å°è£…äº†Builder apiå¸®åŠ©æˆ‘ä»¬å¿«é€Ÿåˆ›å»ºä¸€ä¸ªDaggerAppComponentå®ä¾‹ï¼Œæºç å¦‚ä¸‹ï¼Œä¸€ç›®äº†ç„¶ï¼š

```java
  public static AppComponent create() {
    return new Builder().build();
  }
```

(2) buildé“¾å¼è°ƒç”¨æ–¹å¼

æ—¢ç„¶createæ–¹å¼æ˜¯å¿«é€Ÿåˆ›å»ºçš„ï¼ŒDaggeræ˜¯ä¸ä¼šå¸®æˆ‘ä»¬è°ƒç”¨å…¶ä»–apiçš„è¿™æ—¶æˆ‘ä»¬å¯ä»¥è‡ªå·±æ‰‹åŠ¨åˆ›å»º

```kotlin
DaggerAppComponent.builder().build()
```

æ³¨æ„è¿™é‡Œæœ‰ä¸€ä¸ªç»†èŠ‚AppComponentç®¡ç†çš„class moduleæ˜¯å¯ä»¥buildæ–¹å¼è¿›è¡Œå®ä¾‹èµ‹å€¼çš„ã€‚

å›é¡¾ä¸‹å¦‚ä¸Šæˆ‘ä»¬åˆ›å»ºäº†classç±»å‹çš„ProvidersModuleï¼Œä»¥åŠinterfaceç±»å‹çš„BindsModuleï¼Œè¿™äºŒè€…æœ¬è´¨è¿˜æ˜¯kotlinç±»ï¼Œåœ¨ä½¿ç”¨ä»–ä»¬çš„apiæ—¶æœ¬è´¨è¿˜æ˜¯åˆ›å»ºäº†ä»–ä»¬çš„å®ä¾‹çš„ï¼Œç„¶åå®ä¾‹è°ƒç”¨æ–¹æ³•ã€‚
åªæ˜¯è¿™ä¸€ç»†èŠ‚è¢«Daggeréšè—äº†ã€‚ç»†å¿ƒçš„ä½ ä¼šå‘ç°buildåˆ›å»ºAppComponentå¯¹è±¡æ—¶è¿˜å¯ä»¥å¦‚ä¸‹æ–¹å¼åˆ›å»ºï¼š

```kotlin
DaggerAppComponent.builder().providersModule(ProvidersModule()).build()
```
ProvidersModule å°±æ˜¯class ç±»å‹çš„Moduleï¼ŒDaggeråœ¨buildé‡Œé¢é»˜è®¤ä¸ºæˆ‘ä»¬åŠ äº†è¿™ä¸ªæ–¹æ³•ã€‚é‚£ä¹ˆé—®é¢˜æ¥äº†ï¼Œè¿™ä¸ªæ–¹æ³•çš„ä½œç”¨æ˜¯å•¥å‘¢ï¼Ÿ

æˆ‘æƒ³ä¸€ä¸ªå¾ˆæ˜æ˜¾çš„ä½œç”¨å°±æ˜¯åœ¨ProvidersModuleä¸­æˆ‘ä»¬å¯ä»¥ä½¿ç”¨ApplicationContextäº†ï¼Œå¾ˆç®€å•åªéœ€ä¸ºProvidersModuleçš„æ„é€ ä¸­å®šä¹‰ä¸ªApplicationContextç±»å‹çš„å˜é‡å³å¯ï¼Œ
ç„¶åä½¿ç”¨buildæ–¹å¼åˆ›å»ºå¯¹è±¡æ—¶ä½¿ç”¨ApplicationContextè°ƒç”¨æ—¶æŠŠå‚æ•°ä¼ é€’è¿›å»å³å¯ã€‚

ä¸ºå•¥Daggerä¸ä¸ºBindsModuleæä¾›buildæ–¹æ³•å‘¢ï¼Ÿæˆ‘æƒ³å¤§æ¦‚ç”±äºæ¥å£çš„ç¼˜æ•…Daggerå°±ç›´æ¥æä¾›classç±»å‹çš„ç®—äº†ï¼Œbindséœ€è¦ApplicationContextæ„ä¹‰ä¸å¤§ï¼Œéƒ½æ˜¯æŠ½è±¡æ–¹æ³•æ²¡å•¥å…·ä½“å®ç°æ²¡å¿…è¦è¿™ä¸ªã€‚

###### 2ã€ä¸ºBuilderæ·»åŠ é¢å¤–çš„æ–¹æ³•

è¿™é‡Œå°±éœ€è¦ä½¿ç”¨åˆ°äº†@Component.Builderã€@Component.Factoryï¼ˆå­å®¹å™¨å¯¹åº”çš„@Subcomponent.XXXï¼‰

todo




